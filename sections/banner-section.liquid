{{ 'swiper-bundle.min.css' | asset_url | stylesheet_tag }}
{{ 'banner-section.css' | asset_url | stylesheet_tag }}

<style>
  :root {
    --banner-transition-speed: {{ section.settings.transition_speed | default: 600 }}ms;
  }
</style>

<div class="banner-section{% if section.settings.adapt_height %} adapt-height{% endif %}">
  <div class="swiper banner-swiper">
    <div class="swiper-wrapper">
      {% for block in section.blocks %}
        <div class="swiper-slide">
          <div class="banner-slide position-{{ block.settings.content_position }}">
            
            <!-- Media (Image or Video) -->
            {% if block.settings.show_video and block.settings.video_file != blank %}
              <video 
                class="banner-media banner-video" 
                autoplay 
                muted 
                loop 
                playsinline
                preload="metadata"
                {% if block.settings.desktop_image %}poster="{{ block.settings.desktop_image | image_url }}"{% endif %}
              >
                {% if block.settings.video_file.sources %}
                  {% for source in block.settings.video_file.sources %}
                    <source src="{{ source.url }}" type="{{ source.mime_type }}">
                  {% endfor %}
                {% else %}
                  <source src="{{ block.settings.video_file | file_url }}" type="video/mp4">
                  <source src="{{ block.settings.video_file | file_url }}" type="video/webm">
                  <source src="{{ block.settings.video_file | file_url }}" type="video/ogg">
                {% endif %}
                <!-- Fallback for browsers that don't support video -->
                {% if block.settings.desktop_image %}
                  <img 
                    class="banner-media" 
                    src="{{ block.settings.desktop_image | image_url }}" 
                    alt="{{ block.settings.title | escape }}"
                  >
                {% endif %}
              </video>
            {% else %}
              {% if block.settings.mobile_image and block.settings.desktop_image %}
                <picture>
                  <source media="(max-width: 768px)" srcset="{{ block.settings.mobile_image | image_url }}">
                  <img 
                    class="banner-media" 
                    src="{{ block.settings.desktop_image | image_url }}" 
                    alt="{{ block.settings.title | escape }}"
                    loading="lazy"
                  >
                </picture>
              {% elsif block.settings.desktop_image %}
                <img 
                  class="banner-media" 
                  src="{{ block.settings.desktop_image | image_url }}" 
                  alt="{{ block.settings.title | escape }}"
                  loading="lazy"
                >
              {% endif %}
            {% endif %}

            <!-- Overlay -->
            {% if block.settings.overlay_color and block.settings.overlay_opacity > 0 %}
              <div 
                class="banner-overlay" 
                style="background-color: {{ block.settings.overlay_color }}; opacity: {{ block.settings.overlay_opacity | divided_by: 100.0 }};"
              ></div>
            {% endif %}

            <!-- Content -->
            {% if block.settings.title != blank or block.settings.subtitle != blank or block.settings.button_text != blank %}
              <div 
                class="banner-content{% if block.settings.content_backdrop > 0 %} has-backdrop{% endif %}"
                {% if block.settings.content_backdrop > 0 %}
                  style="--backdrop-blur: {{ block.settings.content_backdrop }}px;"
                {% endif %}
              >
                {% if block.settings.title != blank %}
                  <h1 class="banner-title">{{ block.settings.title }}</h1>
                {% endif %}
                
                {% if block.settings.subtitle != blank %}
                  <p class="banner-subtitle">{{ block.settings.subtitle }}</p>
                {% endif %}
                
                {% if block.settings.button_text != blank and block.settings.button_url != blank %}
                  <a href="{{ block.settings.button_url }}" class="banner-button">
                    {{ block.settings.button_text }}
                  </a>
                {% endif %}
              </div>
            {% endif %}


          </div>
        </div>
      {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if section.blocks.size > 1 %}
      <div class="swiper-pagination"></div>
    {% endif %}
  </div>
</div>

<script src="{{ 'swiper-bundle.min.js' | asset_url }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const swiperConfig = {
      loop: {{ section.blocks.size | json }} > 1,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      speed: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--banner-transition-speed')) || 600,
    };

    {% if section.settings.enable_autoplay %}
      swiperConfig.autoplay = {
        delay: {{ section.settings.autoplay_delay | default: 5000 }},
        disableOnInteraction: false,
      };
    {% endif %}

    const swiper = new Swiper('.banner-swiper', swiperConfig);

    // Handle video loading errors and fallbacks
    const videos = document.querySelectorAll('.banner-video');
    videos.forEach(function(video, index) {
      video.addEventListener('error', function() {
        console.warn('Video failed to load, showing fallback image');
        const fallbackImg = video.querySelector('img');
        if (fallbackImg) {
          video.style.display = 'none';
          fallbackImg.style.display = 'block';
          fallbackImg.classList.add('banner-media');
        }
      });

      video.addEventListener('loadeddata', function() {
        console.log('Video loaded successfully');
      });

      // Ensure video plays on mobile devices
      video.addEventListener('canplay', function() {
        if (video.paused) {
          video.play().catch(function(error) {
            console.warn('Autoplay failed:', error);
            // Show fallback image if autoplay fails
            const fallbackImg = video.querySelector('img');
            if (fallbackImg) {
              video.style.display = 'none';
              fallbackImg.style.display = 'block';
              fallbackImg.classList.add('banner-media');
            }
          });
        }
      });
    });
  });

</script>

{% schema %}
{
  "name": "Banner Section",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "adapt_height",
      "label": "Adapt to image height",
      "default": false,
      "info": "When enabled, the banner height will adapt to the image height instead of using full viewport height"
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "min": 3000,
      "max": 5000,
      "step": 500,
      "unit": "ms",
      "label": "Autoplay delay",
      "default": 5000
    },
    {
      "type": "checkbox",
      "id": "enable_autoplay",
      "label": "Enable autoplay",
      "default": true,
      "info": "Automatically advance slides"
    },
    {
      "type": "range",
      "id": "transition_speed",
      "min": 300,
      "max": 1500,
      "step": 100,
      "unit": "ms",
      "label": "Transition speed",
      "default": 600
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "header",
          "content": "Images"
        },
        {
          "type": "image_picker",
          "id": "desktop_image",
          "label": "Desktop image"
        },
        {
          "type": "image_picker",
          "id": "mobile_image",
          "label": "Mobile image (optional)",
          "info": "If not provided, desktop image will be used for mobile"
        },
        {
          "type": "header",
          "content": "Video Settings"
        },
        {
          "type": "checkbox",
          "id": "show_video",
          "label": "Show video instead of image",
          "default": false
        },
        {
          "type": "video",
          "id": "video_file",
          "label": "Video file",
          "info": "Upload a video file"
        },
        {
          "type": "header",
          "content": "Overlay"
        },
        {
          "type": "color",
          "id": "overlay_color",
          "label": "Overlay color",
          "default": "#000000"
        },
        {
          "type": "range",
          "id": "overlay_opacity",
          "min": 0,
          "max": 100,
          "step": 5,
          "unit": "%",
          "label": "Overlay opacity",
          "default": 30
        },
        {
          "type": "header",
          "content": "Content"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "Celebrate the Season"
        },
        {
          "type": "textarea",
          "id": "subtitle",
          "label": "Subheading",
          "default": "Inspired by the scents of the season, these two gorgeous body oils will usher you into Spring feeling calm, confident, and connected to the earth."
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button text",
          "default": "Shop Now"
        },
        {
          "type": "url",
          "id": "button_url",
          "label": "Button URL"
        },
        {
          "type": "select",
          "id": "content_position",
          "label": "Content position",
          "options": [
            {
              "value": "top-left",
              "label": "Top Left"
            },
            {
              "value": "top-center",
              "label": "Top Center"
            },
            {
              "value": "top-right",
              "label": "Top Right"
            },
            {
              "value": "middle-left",
              "label": "Middle Left"
            },
            {
              "value": "middle-center",
              "label": "Middle Center"
            },
            {
              "value": "middle-right",
              "label": "Middle Right"
            },
            {
              "value": "bottom-left",
              "label": "Bottom Left"
            },
            {
              "value": "bottom-center",
              "label": "Bottom Center"
            },
            {
              "value": "bottom-right",
              "label": "Bottom Right"
            }
          ],
          "default": "middle-center"
        },
        {
          "type": "range",
          "id": "content_backdrop",
          "min": 0,
          "max": 50,
          "step": 1,
          "unit": "px",
          "label": "Content backdrop blur",
          "default": 0,
          "info": "Add backdrop blur effect behind content text"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Banner Section",
      "blocks": [
        {
          "type": "slide"
        }
      ]
    }
  ]
}
{% endschema %}
